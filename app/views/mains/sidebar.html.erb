<% if flash[:welcome] %>
  <%= render 'welcome' %>
<% end %>

<%= render 'shared/navbar' %>

    <link flex href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <%# <script src="script.js" defer></script> %>

    <nav class="sidebar locked">
      <div class="logo_items flex">
        <span class="nav_image">
          <img src="https://res.cloudinary.com/ddxlnxcu5/image/upload/v1726264301/UCR/logo_hwhzun.jpg" alt="logo_img" />
        </span>
        <span class="logo_name">Under Control Racing</span>
        <i class="bx bx-lock-alt" id="lock-icon" title="Unlock Sidebar"></i>
        <i class="bx bx-x" id="sidebar-close"></i>
      </div>

      <div class="menu_container">
        <div class="menu_items">
          <ul class="menu_item">
            <div class="menu_title flex">
              <span class="title">Dashboard</span>
              <span class="line"></span>
            </div>
            <li class="item">
               <a id="drivers" class="link flex" href="javascript:void(0);">
                <i class="bx bx-home-alt"></i>
                <span>Race Results</span>
              </a>
            </li>
            <li class="item">
              <a id="setups" class="link flex" href="javascript:void(0);">
                <i class="bx bx-grid-alt"></i>
                <span>All Setups</span>
              </a>
            </li>
          </ul>

          <ul class="menu_item">
            <div class="menu_title flex">
              <span class="title">Editor</span>
              <span class="line"></span>
            </div>
            <li class="item">
              <a class="link flex">
                <i class="bx bx-award"></i>
                <span>Award</span>
              </a>
            </li>
            <li class="item">
              <a class="link flex">
                <i class="bx bx-folder"></i>
                <span>New Projects</span>
              </a>
            </li>
            <li class="item">
              <a class="link flex">
                <i class="bx bx-cloud-upload"></i>
                <span>Upload New</span>
              </a>
            </li>
          </ul>

          <ul class="menu_item">
            <div class="menu_title flex">
              <span class="title">Setting</span>
              <span class="line"></span>
            </div>
            <li class="item">
              <a class="link flex">
                <i class="bx bx-flag"></i>
                <span>Notice Board</span>
              </a>
            </li>
             <li class="item">
              <a id="profile" class="link flex" href="javascript:void(0);">
                <i class="bx bxs-magic-wand"></i>
                <span>Profile</span>
              </a>
            </li>
          <% if current_user && current_user.admin? %>
            <li class="item">
              <a href="/admin" class="link flex"target= "_blank">
                <i class="bx bx-cog"></i>
                <span>Admin</span>
              </a>
            </li>
          <% end %>
          </ul>
        </div>

        <% if user_signed_in? %>
          <div class="sidebar_profile grid">
            <div class="logout">
              <%= button_to 'Logout', destroy_user_session_path, method: :delete, data: { turbo: false }, class: 'btn btn-logout' %>
            </div>

            <div class="data_text">
              <span class="name"><%= current_user.full_name %></span>
              <span class="email"><%= current_user.email %></span>
            </div>
          </div>
        <% end %>
      </div>
    </nav>

    <div id="main-content" class="main-content" data-turbo="false">
      <!-- O conteúdo da página de edição de usuário será carregado aqui -->
    </div>

<style>
 /* Import Google font - Poppins */
@import url("https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500;600;700&display=swap");
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Poppins", sans-serif;
}
body {
  min-height: 100vh;
  background: #eef5fe;
}
/* Pre css */
.flex {
  display: flex;
  align-items: center;
}
.nav_image {
  display: flex;
  min-width: 55px;
  justify-content: center;
}
.nav_image img {
  height: 45px;
  width: 45px;
  border-radius: 50%;
  object-fit: cover;
}

/* Sidebar */
/* .sidebar {
  position: fixed;
  top: 0;
  left: 0;
  height: 100%;
  width: 270px;
  background: #212121;
  padding: 15px 10px;
  box-shadow: 0 0 2px rgba(0, 0, 0, 0.1);
  transition: all 0.4s ease;
} */

 /* Sidebar */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh; /* Altura da viewport completa */
  width: 270px;
  background: #212121;
  padding: 15px 10px;
  box-shadow: 0 0 2px rgba(0, 0, 0, 0.1);
  overflow: hidden; /* Desabilita qualquer rolagem na sidebar */
}

/* Conteúdo principal */
.main-content {
  margin-left: 270px; /* Espaço deixado pela sidebar fixa */
  padding: 20px;
  background-color: #f5f6f8;
  height: 100vh; /* O conteúdo principal ocupa toda a altura da tela */
  overflow-y: auto; /* Permite rolagem vertical */
  overflow-x: hidden; /* Evita rolagem horizontal */
  width: calc(100% - 270px); /* Calcula a largura restante após a sidebar */
  box-sizing: border-box; /* Garante que padding seja incluído na largura */
}


.sidebar.close {
  width: calc(55px + 20px);
  color: hsla(242, 88.4%, 56.3%, 1);
}
.logo_items {
  gap: 8px;
}
.logo_name {
  font-size: 17px;
  color: #d7d5dd;
  font-weight: 500px;
  transition: all 0.3s ease;
}

.sidebar.close .logo_name,
.sidebar.close #lock-icon,
.sidebar.close #sidebar-close {
  opacity: 0;
  pointer-events: none;
}
#lock-icon,
#sidebar-close {
  padding: 10px;
  color: #f44040;
  font-size: 25px;
  cursor: pointer;
  margin-left: -4px;
  transition: all 0.3s ease;
}
#sidebar-close {
  display: none;
  color: #333;
}
.menu_container {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  margin-top: 40px;
  overflow-y: auto;
  height: calc(100% - 82px);
}
.menu_container::-webkit-scrollbar {
  display: none;
}
.menu_title {
  position: relative;
  height: 50px;
  width: 55px;
}
.menu_title .title {
  margin-left: 15px;
  transition: all 0.3s ease;
  color: aliceblue;
}
.sidebar.close .title {
  opacity: 0;
}
.menu_title .line {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  height: 3px;
  width: 20px;
  border-radius: 25px;
  background: #aaa;
  transition: all 0.3s ease;
}
.menu_title .line {
  opacity: 0;
}
.sidebar.close .line {
  opacity: 1;
}
.item {
  list-style: none;
}
.link {
  text-decoration: none;
  border-radius: 8px;
  margin-bottom: 8px;
  color: hsla(240, 7%, 62%, 1);
}
.link:hover {
  color: #fff;
  background-color: red;
}
.link span {
  white-space: nowrap;
}
.link i {
  height: 50px;
  min-width: 55px;
  display: flex;
  font-size: 22px;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
}

.sidebar_profile {
  padding-top: 15px;
  margin-top: 15px;
  gap: 15px;
  border-top: 2px solid rgba(0, 0, 0, 0.1);
  display: grid;
}
.sidebar_profile .name {
  font-size: 18px;
  color: hsla(240, 7%, 62%, 1);
}
.sidebar_profile .email {
  font-size: 15px;
  color: hsla(240, 7%, 62%, 1);
}

.logout {
  display: flex;
  justify-content: center;
}

.btn-logout {
  background-color: white;
  border-radius: 5px;
  padding: 10px;
  color: #212121;
  text-align: center;
  border: 1px solid white;
  cursor: pointer;
  font-size: 15px;
}

.btn-logout:hover {
  background-color: #f83534;
  color: white;
  border: 1px solid #f83534;
}

/* Navbar */
.navbar {
  max-width: 500px;
  width: 100%;
  position: fixed;
  top: 0;
  left: 60%;
  transform: translateX(-50%);
  background: #fff;
  padding: 10px 20px;
  border-radius: 0 0 8px 8px;
  justify-content: space-between;
}
#sidebar-open {
  font-size: 30px;
  color: #333;
  cursor: pointer;
  margin-right: 20px;
  display: none;
}
.search_box {
  height: 46px;
  max-width: 500px;
  width: 100%;
  border: 1px solid #aaa;
  outline: none;
  border-radius: 8px;
  padding: 0 15px;
  font-size: 18px;
  color: #333;
}
.navbar img {
  height: 40px;
  width: 40px;
  margin-left: 20px;
}

/* Responsive */
@media screen and (max-width: 1100px) {
  .navbar {
    left: 65%;
  }
}
@media screen and (max-width: 800px) {
  .sidebar {
    left: 0;
    z-index: 1000;
  }
  .sidebar.close {
    left: -100%;
  }
  #sidebar-close {
    display: block;
  }
  #lock-icon {
    display: none;
  }
  .navbar {
    left: 0;
    max-width: 100%;
    transform: translateX(0%);
  }
  #sidebar-open {
    display: block;
  }
}

/* Estilo da área de conteúdo principal */
.main-content {
  margin-left: 250px; /* Deixa espaço para o navbar fixo */
  padding: 20px;
  background-color: #f5f6f8;
  height: 100vh;
  overflow-y: auto;
}
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<%# RACE PAGE %>
<script>
  document.getElementById('race').addEventListener('click', function() {
    // Faz o AJAX para carregar o conteúdo da página de edição do usuário
    $.ajax({
      url: "/resultados", // Caminho da página de edição
      type: 'GET',
      dataType: 'html', // O retorno será HTML
      success: function(data) {
        // Insere o conteúdo carregado no div da área principal
        document.getElementById('main-content').innerHTML = data;
      },
      error: function() {
        // Caso ocorra algum erro no carregamento
        document.getElementById('main-content').innerHTML = '<p>Failed to load user settings.</p>';
      }
    });
  });
</script>

<%# SETUPS PAGE %>
<script>
  document.getElementById('setups').addEventListener('click', function() {
    // Faz o AJAX para carregar o conteúdo da página de edição do usuário
    $.ajax({
      url: "/setups", // Caminho da página de edição
      type: 'GET',
      dataType: 'html', // O retorno será HTML
      success: function(data) {
        // Insere o conteúdo carregado no div da área principal
        document.getElementById('main-content').innerHTML = data;
      },
      error: function() {
        // Caso ocorra algum erro no carregamento
        document.getElementById('main-content').innerHTML = '<p>Failed to load user settings.</p>';
      }
    });
  });
</script>

<%# DRIVERS PAGE %>
<script>
  document.getElementById('drivers').addEventListener('click', function() {
  $.ajax({
    url: "/drivers",
    type: 'GET',
    dataType: 'html',
    success: function(data) {
      document.getElementById('main-content').innerHTML = data;
    },
    error: function() {
      document.getElementById('main-content').innerHTML = '<p>Failed to load content.</p>';
    }
  });
});

</script>

<%# PROFILE PAGE %>
<script>
  document.getElementById('profile').addEventListener('click', function(event) {
  event.preventDefault(); // Previne a ação padrão do link

  // Faz o AJAX para carregar o conteúdo da página de edição do usuário
  $.ajax({
    url: "/users/edit", // Caminho da página de edição
    type: 'GET',
    dataType: 'html',
    success: function(data) {
      // Insere o conteúdo carregado no div da área principal sem remover a sidebar
      document.getElementById('main-content').innerHTML = data;

      // Após carregar o conteúdo, associamos o evento de submit do formulário via AJAX
      var form = document.querySelector('.edit-profile-form');
      form.addEventListener('submit', function(e) {
        e.preventDefault(); // Previne o envio padrão do formulário

        // Limpar mensagens de erro e sucesso anteriores
        const existingMessages = document.querySelectorAll('.alert');
        existingMessages.forEach(function(message) {
          message.remove(); // Remove todas as mensagens antigas
        });

        var formData = new FormData(form);

        $.ajax({
          url: form.action,
          type: 'PUT',
          data: formData,
          processData: false,
          contentType: false,
          success: function(response) {
            // Atualiza o conteúdo da página com o HTML que contém a imagem atualizada
            document.getElementById('main-content').innerHTML = response.html;

            // Exibe uma mensagem de sucesso (opcional)
            var successMessage = document.createElement('div');
            successMessage.classList.add('alert', 'alert-success');
            successMessage.textContent = response.message;
            document.getElementById('main-content').prepend(successMessage);

            // Atualiza o nome e e-mail na sidebar
            document.querySelector('.sidebar_profile .name').textContent = response.updated_user.full_name;
            document.querySelector('.sidebar_profile .email').textContent = response.updated_user.email;

            // Ocultar a mensagem após 3 segundos
            hideAlertAutomatically();
          },
          error: function(response) {
            // Exibe os erros
            var errorMessage = document.createElement('div');
            errorMessage.classList.add('alert', 'alert-danger');
            errorMessage.innerHTML = response.responseJSON.errors.join('<br>');
            document.getElementById('main-content').prepend(errorMessage);

            // Ocultar a mensagem de erro após 3 segundos
            hideAlertAutomatically();
          }
        });
      });
    },
    error: function() {
      // Caso ocorra algum erro ao carregar a página de edição
      document.getElementById('main-content').innerHTML = '<p>Failed to load user settings.</p>';
    }
  });
});

// Função para ocultar o alerta após 3 segundos
function hideAlertAutomatically() {
  var alertElement = document.querySelector('.alert');

  if (alertElement) {
    setTimeout(function() {
      alertElement.style.opacity = '0'; // Faz o alerta desaparecer suavemente
      setTimeout(function() {
        alertElement.style.display = 'none'; // Remove o alerta do fluxo do layout após a transição
      }, 500); // Aguarda o fim da transição (0.5 segundos)
    }, 3000); // 3 segundos
  }
}
</script>

<script>
  // Selecting the sidebar and buttons
const sidebar = document.querySelector(".sidebar");
const sidebarOpenBtn = document.querySelector("#sidebar-open");
const sidebarCloseBtn = document.querySelector("#sidebar-close");
const sidebarLockBtn = document.querySelector("#lock-icon");

// Function to toggle the lock state of the sidebar
const toggleLock = () => {
  sidebar.classList.toggle("locked");
  // If the sidebar is not locked
  if (!sidebar.classList.contains("locked")) {
    sidebar.classList.add("hoverable");
    sidebarLockBtn.classList.replace("bx-lock-alt", "bx-lock-open-alt");
  } else {
    sidebar.classList.remove("hoverable");
    sidebarLockBtn.classList.replace("bx-lock-open-alt", "bx-lock-alt");
  }
};

// Function to hide the sidebar when the mouse leaves
const hideSidebar = () => {
  if (sidebar.classList.contains("hoverable")) {
    sidebar.classList.add("close");
  }
};

// Function to show the sidebar when the mouse enter
const showSidebar = () => {
  if (sidebar.classList.contains("hoverable")) {
    sidebar.classList.remove("close");
  }
};

// Function to show and hide the sidebar
const toggleSidebar = () => {
  sidebar.classList.toggle("close");
};

// If the window width is less than 800px, close the sidebar and remove hoverability and lock
if (window.innerWidth < 800) {
  sidebar.classList.add("close");
  sidebar.classList.remove("locked");
  sidebar.classList.remove("hoverable");
}

// Adding event listeners to buttons and sidebar for the corresponding actions
sidebarLockBtn.addEventListener("click", toggleLock);
sidebar.addEventListener("mouseleave", hideSidebar);
sidebar.addEventListener("mouseenter", showSidebar);
sidebarOpenBtn.addEventListener("click", toggleSidebar);
sidebarCloseBtn.addEventListener("click", toggleSidebar);

</script>
