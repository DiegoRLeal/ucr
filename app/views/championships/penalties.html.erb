<%= form_with model: @championship, local: true, data: { turbo: false } do |f| %>
  <h3>Penalidades</h3>
  <table>
    <thead>
      <tr>
        <th>Motivo da Penalidade</th>
        <th>Tipo da Penalidade</th>
        <th>Valor (segundos)</th>
        <th>Volta da Violação</th>
        <th>Volta da Limpeza</th>
        <th>Pontos de Penalidade</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="penalty-fields">
      <% penalty_reasons = @championship.penalty_reason || [] %>
      <% penalty_types = @championship.penalty_type || [] %>
      <% penalty_values = @championship.penalty_value || [] %>
      <% penalty_violation_in_laps = @championship.penalty_violation_in_lap || [] %>
      <% penalty_cleared_in_laps = @championship.penalty_cleared_in_lap || [] %>
      <% penalty_points = @championship.penalty_points || [] %>

      <% penalty_reasons.each_with_index do |reason, index| %>
        <tr class="penalty-row">
          <td><%= f.text_field "penalty_reason[]", value: reason %></td>
          <td><%= f.text_field "penalty_type[]", value: penalty_types[index] %></td>
          <td><%= f.number_field "penalty_value[]", value: penalty_values[index] %></td>
          <td><%= f.number_field "penalty_violation_in_lap[]", value: penalty_violation_in_laps[index] %></td>
          <td><%= f.number_field "penalty_cleared_in_lap[]", value: penalty_cleared_in_laps[index] %></td>
          <td><%= f.number_field "penalty_points[]", value: penalty_points[index], class: 'penalty-points-field' %></td>
          <td>
            <%= link_to 'Remover', '#', class: 'remove-penalty btn btn-danger', data: { index: index } %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <h4>Total de Pontos Subtraídos: <span id="total-points"><%= penalty_points.sum %></span></h4>

  <!-- Botão para adicionar nova linha de penalidade -->
  <%= link_to 'Adicionar Penalidade', '#', id: 'add-penalty', class: 'btn btn-success' %>

  <!-- Botão de submit -->
  <%= f.submit 'Salvar Penalidades', class: 'btn btn-primary' %>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    function recalculateTotalPoints() {
      let total = 0;
      document.querySelectorAll('.penalty-points-field').forEach(field => {
        const value = parseInt(field.value);
        if (!isNaN(value) && value !== 0) {
          total += value;
        }
      });
      document.getElementById('total-points').textContent = total;
    }

    // Adiciona evento para recalcular os pontos quando valores mudam
    document.addEventListener('input', function (e) {
      if (e.target && e.target.matches('.penalty-points-field')) {
        recalculateTotalPoints();
      }
    });

    document.getElementById('add-penalty').addEventListener('click', (e) => {
      e.preventDefault();
      const newPenaltyRow = `
        <tr class="penalty-row">
          <td><input type="text" name="championship[penalty_reason][]" value="" /></td>
          <td><input type="text" name="championship[penalty_type][]" value="" /></td>
          <td><input type="number" name="championship[penalty_value][]" value="0" /></td>
          <td><input type="number" name="championship[penalty_violation_in_lap][]" value="0" /></td>
          <td><input type="number" name="championship[penalty_cleared_in_lap][]" value="0" /></td>
          <td><input type="number" name="championship[penalty_points][]" value="0" class="penalty-points-field" /></td>
          <td><a href="#" class="remove-penalty btn btn-danger">Remover</a></td>
        </tr>`;
      document.getElementById('penalty-fields').insertAdjacentHTML('beforeend', newPenaltyRow);
      recalculateTotalPoints();
    });

    document.addEventListener('click', function (e) {
      if (e.target && e.target.matches('.remove-penalty')) {
        e.preventDefault();
        e.target.closest('.penalty-row').remove();
        recalculateTotalPoints();
      }
    });
  });
</script>
